# 我是如何写 Vue 单元测试的

从使用 Vue 写出第一个 `Hello world` 到现在已经有近两年时间了，期间利用业余时间折腾了一套组件 we-vue，起初是出于实践学到的新知识，更多的是玩的意思，不过后来维护的过程中渐渐积累了一些经验，并开始享受这种过程。

在 we-vue 更新到 v2.0 的时候，开始全面地编写单元测试。起先使用 karma + mocha + chrome-headless 这种组合完成的行级覆盖率达到 96% 的单元测试。但最近，经过一番权衡之后，又决定放弃了这种组合，使用 jest 替代之。在这连番的折腾中，入过不少坑（当然，很多时候是自己挖坑自己跳），也解锁了不少新姿势，这也是本文中要讲的。

## 为什么要写单元测试

作为一个程序员，单元测试或许是一个绕不开的课题。我大致总结了一下当初决定做单元测试的原因如下：

1. 有单元测试的项目，显得更专业，更有 B 格，真的，自己认真想了下，这确实是自己的首要出发点，比较俗吧？ :smile:

2. 单元测试能避免出现一些代码运行结果与预期不符的错误，例如，期望页面显示文字 A，而实际上却出现了个 B。

3. 单元测试能够避免在，升级更新、或者修复 BUG 的时候引入一些意料之外的问题。

总之，单元测试能提高程序的可靠性，让开发者在发布时更有底气，让使用者更有安全感。虽然编写单元测试需要花费一些时间，但相比于它所带来的优势，这些时间和精力上的花费还是十分值得的。

另外值得注意的是，单元测试并不能完全代替功能测试，因为程序本身设计的逻辑错误或者其它的一些环境因素所造成的影响，单元测试是没办法全测出来的。所以，单元测试只是保证你想程序模块输入一只猪，它不会整出一头驴来。甚至进一步的功能测试或者说“肉测”，仍然是有必要的。

## 用到的一些工具（软件）

### 操个趁手的家伙 -- WebStorm 或 Visual Studio Code

一个好用的 IDE 或者编辑器，能让效率飞升。就我个人而言，大部分时间使用 WebStorm，其本身对 Vue.js 就有很好的支持（内置了相关的插件）同时也支持的各种测试框架，适当的配置之后，可以很方便的进行断点、查看规模之类的调试工作。

此外，Visual Studio Code 也是个不错的选择，目前已不有少 Vue.js 开发和测试相关的插件了，只需要搜索加点击但可安装。

> 当然，这里我无意挑起各种 IDE 或者编辑器流派之争端，提到的两个只是自己个人喜好。大家可自行选择合适的，甚至只要自己喜欢且觉得方便，用记事本开干也完全没问题。

### 用成熟好用的测试框架 -- vue-test-utils

vue-test-utils 也是 Vue 生态圈中的一个开源项目，截至日前（2018-0-21）仍然处于 Beta 阶段，

vue-test-utils 的前身是 avoriaz，出自同一个作者，avariaz 也是一个不错的包，但其 README 中说明的那样，当 vue-test-utils 正式发布的时候， avariaz 将会被废弃。

有时候我也会使用 Visual Studio Code

### 选择一个好的断言库

即使是在一开始使用 karma + mocha 进行测试的时候，我也没有使用 vue-cli 默认模板里配置的 chai，而是自行安装配置了 expect.js (expect 是 jest 的一部分，可以单独安装使用)。主要是出于对 expect 断言函数和语法方面的喜爱，这也为后期迁移到 jest 省了不少事。

当然，chai 也是一个很优化的库，是否选择取决于个人喜好以及项目的实际情况。

## 利用 CI 平台自动进行单元测试、构建以及发布

现在已经有不少 CI 服务平台，对于开源的项目，能免费使用这些平台的服务持续集成一些日常构建、测试工作。

TravisCI 和 CircleCI 是两个比较有代表性的，而个人目前使用 CircleCI，具体原因就不多说了，使用哪个取决于自身喜好和具体业务情况。

## 题外话

### karma + mocha + Chrome(headless 模式)

其实对也可以使用 jest，起初自己也作过这方面的尝试，但由于 vue-jest 等辅助包仍不完善，使得测试时无法加载样式文件等问题而最终放弃，并决定使用 karme + mocha 这黄金搭档来执行测试。

新版本的 Chrome 支持以 headless 模式运行，这对于测试这种不需要显示界面的任务来说是很合适了。

与之相对的，你也可以考虑使用 PhantomJS 来模拟浏览器环境，但它有着不少问题，而且更新进度越来越慢，昨日 2018-03-05 得知，因为开发组内部意见不合，phantomJS 项目已经封存了代码，暂停开发了。